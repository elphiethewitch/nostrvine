---
title: "6:31:06 PM - October 13, 2025"
date: 2025-10-13T23:31:06.391Z
timestamp: 1760398266391
---

## Project Notes

Upload Manager Thumbnail URL Race Condition Fix (commit a6cec2b):

Location: lib/services/upload_manager.dart:564-576 (_handleUploadSuccess method)

The Problem:
User reported being stuck on upload screen even though logs showed successful thumbnail upload and Nostr event publishing. Published events were missing 'image' component in imeta tags.

Root Cause Analysis:
1. _executeUploadWithTimeout() uploads thumbnail and stores URL at line 551: 
   `await _updateUpload(upload.copyWith(thumbnailPath: thumbnailCdnUrl));`

2. _handleUploadSuccess() called with OLD upload parameter from line 443

3. _createSuccessfulUpload() at line 575 creates new record from stale upload

4. Thumbnail URL update gets overwritten

The Fix:
```dart
// Get the LATEST upload record from Hive (may have been updated with thumbnail URL)
final latestUpload = getUpload(upload.id) ?? upload;

// Create updated upload with success metadata
final updatedUpload = _createSuccessfulUpload(latestUpload, result);
```

This ensures _createSuccessfulUpload() receives the upload record that includes the thumbnail URL.

Testing:
- Existing tests passed (upload_manager_thumbnail_test.dart, upload_publish_race_condition_test.dart)
- Created new integration test: thumbnail_url_preservation_test.dart
- All tests green

Next Steps:
- Need manual testing to verify UI now navigates away from upload screen
- Consider adding more integration tests for complete upload â†’ publish flow
- User suggested need for integration tests - this fix addresses that
